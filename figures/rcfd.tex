\begin{figure}[tp]
\begin{minted}{ocaml}
type state =
  | Open of Unix.file_descr
  | Closing of (unit -> unit)
type t =
  { mutable ops: int [@atomic];
    mutable state: state [@atomic];
  }

let close t =
  match t.state with
  | Open fd as prev ->
      let next = Closing (fun () -> Unix.close fd) in
      if Atomic.Loc.compare_and_set [%atomic.loc t.state] prev next then (
        if t.ops == 0
        && Atomic.Loc.compare_and_set [%atomic.loc t.state] next closed
        then
          close () ;
        true
      ) else (
        false
      )
  | Closing _ ->
      false
\end{minted}
\caption{\mintinline{ocaml}{Rcfd.close} function from the \Eio~\cite{eio} library}
\label{fig:rcfd}
\end{figure}

% [Gabriel]: je ne comprends pas le type de l'appel à [close ()] dans une branche, on dirait un appel récursif, mais la fonction [let close t] n'est pas déclarée [let rec] et le type ne colle pas.

% [Gabriel]: je ne sais pas ce que vaut [closed] ci-dessus.